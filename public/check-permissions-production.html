<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnostic Permissions - Production</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.success {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
        }

        .result.error {
            background: #fff5f5;
            border-left-color: #f56565;
        }

        .result.success {
            background: #f0fff4;
            border-left-color: #48bb78;
        }

        .result.warning {
            background: #fffaf0;
            border-left-color: #ed8936;
        }

        .result pre {
            background: white;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.6;
            margin-top: 10px;
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .badge.admin {
            background: #667eea;
            color: white;
        }

        .badge.manager {
            background: #48bb78;
            color: white;
        }

        .badge.cashier {
            background: #ed8936;
            color: white;
        }

        .badge.server {
            background: #4299e1;
            color: white;
        }

        .badge.success {
            background: #48bb78;
            color: white;
        }

        .badge.error {
            background: #f56565;
            color: white;
        }

        .badge.warning {
            background: #ed8936;
            color: white;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .menu-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .menu-item {
            padding: 12px;
            background: white;
            border-radius: 6px;
            border: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .menu-item.accessible {
            border-color: #48bb78;
            background: #f0fff4;
        }

        .menu-item.blocked {
            border-color: #f56565;
            background: #fff5f5;
            opacity: 0.7;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert.info {
            background: #ebf8ff;
            color: #2c5282;
            border-left: 4px solid #4299e1;
        }

        .alert.danger {
            background: #fff5f5;
            color: #742a2a;
            border-left: 4px solid #f56565;
        }

        .alert.success {
            background: #f0fff4;
            color: #22543d;
            border-left: 4px solid #48bb78;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üîç Diagnostic Permissions - Production</h1>
            <p class="subtitle">Outil de diagnostic pour v√©rifier l'√©tat des permissions en production</p>

            <div class="alert info">
                <strong>‚ÑπÔ∏è Information :</strong> Cet outil permet de diagnostiquer pourquoi les menus sont diff√©rents entre local et production.
            </div>

            <!-- Section 1: Configuration -->
            <div class="section">
                <div class="section-title">1Ô∏è‚É£ Configuration</div>
                
                <div class="input-group">
                    <label for="apiUrl">URL de l'API Backend</label>
                    <select id="apiUrl">
                        <option value="https://barstock-api.onrender.com/api">Production (Render)</option>
                        <option value="http://127.0.0.1:8000/api">Local (Dev)</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="token">Token JWT (depuis localStorage)</label>
                    <input type="text" id="token" placeholder="Collez votre token JWT ici...">
                </div>

                <button onclick="loadTokenFromStorage()">üìã Charger depuis localStorage</button>
                <button onclick="testConnection()" class="secondary">üîå Tester la connexion</button>
            </div>

            <!-- Section 2: Diagnostic -->
            <div class="section">
                <div class="section-title">2Ô∏è‚É£ Diagnostic Complet</div>
                
                <button onclick="runFullDiagnostic()">üöÄ Lancer le diagnostic complet</button>
                <button onclick="checkPermissions()" class="secondary">üë§ V√©rifier mes permissions</button>
                <button onclick="checkAllPermissions()" class="success">üìã Lister toutes les permissions</button>
                
                <div id="diagnosticResult"></div>
            </div>

            <!-- Section 2.5: Initialisation (NOUVEAU) -->
            <div class="section">
                <div class="section-title">‚ö° Initialisation des Permissions (SANS SHELL)</div>
                
                <div class="alert info">
                    <strong>üéØ Solution pour le plan gratuit Render :</strong> Cliquez sur le bouton ci-dessous pour initialiser les permissions directement via l'API (admin uniquement).
                </div>

                <button onclick="initializePermissions()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); font-size: 18px; padding: 16px 32px;">
                    üöÄ INITIALISER LES PERMISSIONS
                </button>
                
                <div id="initResult"></div>
            </div>

            <!-- Section 3: Solution -->
            <div class="section">
                <div class="section-title">3Ô∏è‚É£ Solution</div>
                
                <div class="alert danger">
                    <strong>‚ö†Ô∏è Probl√®me identifi√© :</strong> Les permissions n'ont pas √©t√© initialis√©es en production.
                </div>

                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 15px;">
                    <h3 style="margin-bottom: 15px; color: #333;">üîß Commandes √† ex√©cuter en production :</h3>
                    <pre style="background: #2d3748; color: #48bb78; padding: 15px; border-radius: 6px; overflow-x: auto;">
# Se connecter au serveur de production (Render)
# Via le dashboard Render > Shell

# 1. Cr√©er les permissions par d√©faut
python manage.py init_role_permissions

# 2. V√©rifier que les permissions ont √©t√© cr√©√©es
python manage.py shell
>>> from accounts.models import Permission, UserPermission
>>> print(f"Permissions: {Permission.objects.count()}")
>>> print(f"UserPermissions: {UserPermission.objects.count()}")
>>> exit()

# 3. Red√©marrer l'application (optionnel)
# Via le dashboard Render > Manual Deploy > Deploy latest commit
                    </pre>
                </div>

                <div class="alert success" style="margin-top: 20px;">
                    <strong>‚úÖ Apr√®s l'ex√©cution :</strong> Les caissiers et serveurs verront les m√™mes menus qu'en local.
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_ENDPOINTS = {
            checkPermissions: '/accounts/check-permissions/',
            listPermissions: '/accounts/permissions/',
            listUsers: '/accounts/users/',
            initializePermissions: '/accounts/permissions/initialize/',
        };

        function getApiUrl() {
            return document.getElementById('apiUrl').value;
        }

        function getToken() {
            return document.getElementById('token').value.trim();
        }

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="result ${type}">${content}</div>`;
        }

        function loadTokenFromStorage() {
            const token = localStorage.getItem('token');
            if (token) {
                document.getElementById('token').value = token;
                showResult('diagnosticResult', 
                    `<strong>‚úÖ Token charg√© depuis localStorage</strong><br>
                    <small>Token: ${token.substring(0, 50)}...</small>`, 
                    'success'
                );
            } else {
                showResult('diagnosticResult', 
                    '<strong>‚ùå Aucun token trouv√© dans localStorage</strong><br>Connectez-vous d\'abord sur l\'application.', 
                    'error'
                );
            }
        }

        async function testConnection() {
            const apiUrl = getApiUrl();
            const token = getToken();

            if (!token) {
                showResult('diagnosticResult', '<strong>‚ùå Erreur :</strong> Veuillez fournir un token JWT.', 'error');
                return;
            }

            showResult('diagnosticResult', '<strong>üîÑ Test de connexion en cours...</strong><div class="loading"></div>');

            try {
                const response = await fetch(`${apiUrl}${API_ENDPOINTS.checkPermissions}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    showResult('diagnosticResult', 
                        `<strong>‚úÖ Connexion r√©ussie !</strong><br>
                        <span class="badge ${data.role}">${data.role.toUpperCase()}</span>
                        <pre>${JSON.stringify(data, null, 2)}</pre>`, 
                        'success'
                    );
                } else {
                    const error = await response.text();
                    showResult('diagnosticResult', 
                        `<strong>‚ùå Erreur ${response.status} :</strong> ${response.statusText}<br>
                        <pre>${error}</pre>`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('diagnosticResult', 
                    `<strong>‚ùå Erreur de connexion :</strong> ${error.message}`, 
                    'error'
                );
            }
        }

        async function checkPermissions() {
            const apiUrl = getApiUrl();
            const token = getToken();

            if (!token) {
                showResult('diagnosticResult', '<strong>‚ùå Erreur :</strong> Veuillez fournir un token JWT.', 'error');
                return;
            }

            showResult('diagnosticResult', '<strong>üîÑ V√©rification des permissions...</strong><div class="loading"></div>');

            try {
                const response = await fetch(`${apiUrl}${API_ENDPOINTS.checkPermissions}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    const permissionCount = Object.keys(data.permissions).length;
                    const categoryCount = Object.keys(data.permissions_by_category || {}).length;

                    let html = `
                        <strong>üë§ Informations utilisateur :</strong><br>
                        <span class="badge ${data.role}">${data.role.toUpperCase()}</span>
                        <br><br>
                        <div class="stats">
                            <div class="stat-card">
                                <div class="stat-value">${permissionCount}</div>
                                <div class="stat-label">Permissions</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${categoryCount}</div>
                                <div class="stat-label">Cat√©gories</div>
                            </div>
                        </div>
                    `;

                    if (permissionCount === 0) {
                        html += `
                            <div class="alert danger" style="margin-top: 20px;">
                                <strong>‚ö†Ô∏è PROBL√àME D√âTECT√â :</strong> Aucune permission trouv√©e !<br>
                                Les permissions n'ont pas √©t√© initialis√©es en production.<br>
                                Ex√©cutez la commande : <code>python manage.py init_role_permissions</code>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="alert success" style="margin-top: 20px;">
                                <strong>‚úÖ Permissions initialis√©es correctement</strong>
                            </div>
                        `;
                    }

                    html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;

                    showResult('diagnosticResult', html, permissionCount === 0 ? 'error' : 'success');
                } else {
                    const error = await response.text();
                    showResult('diagnosticResult', 
                        `<strong>‚ùå Erreur ${response.status} :</strong> ${response.statusText}<br>
                        <pre>${error}</pre>`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('diagnosticResult', 
                    `<strong>‚ùå Erreur :</strong> ${error.message}`, 
                    'error'
                );
            }
        }

        async function checkAllPermissions() {
            const apiUrl = getApiUrl();
            const token = getToken();

            if (!token) {
                showResult('diagnosticResult', '<strong>‚ùå Erreur :</strong> Veuillez fournir un token JWT.', 'error');
                return;
            }

            showResult('diagnosticResult', '<strong>üîÑ R√©cup√©ration de toutes les permissions...</strong><div class="loading"></div>');

            try {
                const response = await fetch(`${apiUrl}${API_ENDPOINTS.listPermissions}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    const permissions = data.results || data;
                    const count = permissions.length;

                    let html = `
                        <strong>üìã Toutes les permissions disponibles :</strong><br>
                        <div class="stats">
                            <div class="stat-card">
                                <div class="stat-value">${count}</div>
                                <div class="stat-label">Permissions totales</div>
                            </div>
                        </div>
                    `;

                    if (count === 0) {
                        html += `
                            <div class="alert danger" style="margin-top: 20px;">
                                <strong>‚ö†Ô∏è PROBL√àME CRITIQUE :</strong> Aucune permission n'existe dans la base de donn√©es !<br>
                                Vous devez ex√©cuter : <code>python manage.py init_role_permissions</code>
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="alert success" style="margin-top: 20px;">
                                <strong>‚úÖ ${count} permissions trouv√©es</strong>
                            </div>
                        `;
                    }

                    html += `<pre>${JSON.stringify(permissions, null, 2)}</pre>`;

                    showResult('diagnosticResult', html, count === 0 ? 'error' : 'success');
                } else {
                    const error = await response.text();
                    showResult('diagnosticResult', 
                        `<strong>‚ùå Erreur ${response.status} :</strong> ${response.statusText}<br>
                        <pre>${error}</pre>`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('diagnosticResult', 
                    `<strong>‚ùå Erreur :</strong> ${error.message}`, 
                    'error'
                );
            }
        }

        async function runFullDiagnostic() {
            const apiUrl = getApiUrl();
            const token = getToken();

            if (!token) {
                showResult('diagnosticResult', '<strong>‚ùå Erreur :</strong> Veuillez fournir un token JWT.', 'error');
                return;
            }

            showResult('diagnosticResult', '<strong>üîÑ Diagnostic complet en cours...</strong><div class="loading"></div>');

            try {
                // 1. V√©rifier les permissions utilisateur
                const userPermsResponse = await fetch(`${apiUrl}${API_ENDPOINTS.checkPermissions}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                // 2. Lister toutes les permissions
                const allPermsResponse = await fetch(`${apiUrl}${API_ENDPOINTS.listPermissions}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (userPermsResponse.ok && allPermsResponse.ok) {
                    const userData = await userPermsResponse.json();
                    const allPermsData = await allPermsResponse.json();
                    const allPermissions = allPermsData.results || allPermsData;

                    const userPermCount = Object.keys(userData.permissions).length;
                    const totalPermCount = allPermissions.length;

                    let html = `
                        <strong>üéØ R√©sultat du diagnostic complet :</strong><br><br>
                        <div class="stats">
                            <div class="stat-card">
                                <div class="stat-value">${userPermCount}</div>
                                <div class="stat-label">Mes permissions</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${totalPermCount}</div>
                                <div class="stat-label">Permissions totales</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${userData.role}</div>
                                <div class="stat-label">Mon r√¥le</div>
                            </div>
                        </div>
                    `;

                    // Diagnostic
                    if (totalPermCount === 0) {
                        html += `
                            <div class="alert danger" style="margin-top: 20px;">
                                <strong>üö® PROBL√àME CRITIQUE D√âTECT√â :</strong><br>
                                ‚ùå Aucune permission n'existe dans la base de donn√©es<br>
                                ‚ùå La commande <code>init_role_permissions</code> n'a jamais √©t√© ex√©cut√©e<br>
                                ‚ùå Tous les utilisateurs (sauf admin) n'ont acc√®s √† aucun menu<br><br>
                                <strong>üìù SOLUTION :</strong> Ex√©cutez la commande ci-dessous dans la section 3Ô∏è‚É£
                            </div>
                        `;
                    } else if (userPermCount === 0 && userData.role !== 'admin') {
                        html += `
                            <div class="alert warning" style="margin-top: 20px;">
                                <strong>‚ö†Ô∏è PROBL√àME PARTIEL :</strong><br>
                                ‚úÖ ${totalPermCount} permissions existent dans la base<br>
                                ‚ùå Mais aucune permission n'est assign√©e √† votre compte (${userData.role})<br><br>
                                <strong>üìù SOLUTION :</strong> R√©ex√©cutez <code>init_role_permissions</code> pour assigner les permissions
                            </div>
                        `;
                    } else {
                        html += `
                            <div class="alert success" style="margin-top: 20px;">
                                <strong>‚úÖ SYST√àME FONCTIONNEL :</strong><br>
                                ‚úÖ ${totalPermCount} permissions existent<br>
                                ‚úÖ ${userPermCount} permissions assign√©es √† votre compte<br>
                                ‚úÖ Les menus devraient s'afficher correctement
                            </div>
                        `;
                    }

                    // D√©tails
                    html += `
                        <h3 style="margin-top: 30px; margin-bottom: 15px;">üìä D√©tails :</h3>
                        <details>
                            <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">üë§ Mes permissions</summary>
                            <pre>${JSON.stringify(userData, null, 2)}</pre>
                        </details>
                        <details style="margin-top: 15px;">
                            <summary style="cursor: pointer; font-weight: 600; margin-bottom: 10px;">üìã Toutes les permissions</summary>
                            <pre>${JSON.stringify(allPermissions, null, 2)}</pre>
                        </details>
                    `;

                    showResult('diagnosticResult', html, totalPermCount === 0 ? 'error' : (userPermCount === 0 ? 'warning' : 'success'));
                } else {
                    showResult('diagnosticResult', 
                        `<strong>‚ùå Erreur lors du diagnostic</strong><br>
                        User perms: ${userPermsResponse.status}<br>
                        All perms: ${allPermsResponse.status}`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('diagnosticResult', 
                    `<strong>‚ùå Erreur :</strong> ${error.message}`, 
                    'error'
                );
            }
        }

        async function initializePermissions() {
            const apiUrl = getApiUrl();
            const token = getToken();

            if (!token) {
                showResult('initResult', '<strong>‚ùå Erreur :</strong> Veuillez fournir un token JWT.', 'error');
                return;
            }

            // Confirmation avant l'action
            if (!confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir initialiser les permissions ?\n\nCette action va :\n- Cr√©er toutes les permissions par d√©faut\n- Assigner les permissions aux utilisateurs selon leur r√¥le\n- R√©initialiser les permissions existantes\n\nContinuer ?')) {
                return;
            }

            showResult('initResult', '<strong>üîÑ Initialisation en cours...</strong><div class="loading"></div>');

            try {
                const response = await fetch(`${apiUrl}${API_ENDPOINTS.initializePermissions}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json',
                    },
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    let html = `
                        <strong>‚úÖ ${data.message}</strong><br><br>
                        <div class="stats">
                            <div class="stat-card">
                                <div class="stat-value">${data.stats.permissions_created}</div>
                                <div class="stat-label">Permissions cr√©√©es</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.stats.permissions_existing}</div>
                                <div class="stat-label">D√©j√† existantes</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.stats.permissions_total}</div>
                                <div class="stat-label">Total</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${data.stats.users_updated}</div>
                                <div class="stat-label">Utilisateurs mis √† jour</div>
                            </div>
                        </div>
                    `;

                    if (data.users && data.users.length > 0) {
                        html += `
                            <h3 style="margin-top: 30px; margin-bottom: 15px;">üë• Utilisateurs mis √† jour :</h3>
                            <div style="display: grid; gap: 10px;">
                        `;
                        
                        data.users.forEach(user => {
                            html += `
                                <div style="background: white; padding: 15px; border-radius: 8px; border: 2px solid #48bb78;">
                                    <strong>${user.username}</strong>
                                    <span class="badge ${user.role}">${user.role.toUpperCase()}</span>
                                    <span class="badge success">${user.permissions_count} permissions</span>
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }

                    html += `
                        <div class="alert success" style="margin-top: 20px;">
                            <strong>üéâ Succ√®s !</strong><br>
                            ${data.note}<br><br>
                            <strong>üìù Prochaines √©tapes :</strong><br>
                            1. D√©connectez-vous de l'application<br>
                            2. Reconnectez-vous avec un compte caissier/serveur<br>
                            3. V√©rifiez que tous les menus sont maintenant visibles
                        </div>
                    `;

                    showResult('initResult', html, 'success');

                    // Relancer automatiquement le diagnostic apr√®s 2 secondes
                    setTimeout(() => {
                        runFullDiagnostic();
                    }, 2000);

                } else if (response.status === 403) {
                    showResult('initResult', 
                        `<strong>‚ùå Acc√®s refus√©</strong><br>
                        Seuls les administrateurs peuvent initialiser les permissions.<br>
                        Connectez-vous avec un compte admin.`, 
                        'error'
                    );
                } else {
                    const error = await response.text();
                    showResult('initResult', 
                        `<strong>‚ùå Erreur ${response.status} :</strong> ${response.statusText}<br>
                        <pre>${error}</pre>`, 
                        'error'
                    );
                }
            } catch (error) {
                showResult('initResult', 
                    `<strong>‚ùå Erreur de connexion :</strong> ${error.message}<br>
                    V√©rifiez que l'URL de l'API est correcte et que le serveur est accessible.`, 
                    'error'
                );
            }
        }

        // Auto-load token on page load
        window.addEventListener('load', () => {
            const token = localStorage.getItem('token');
            if (token) {
                document.getElementById('token').value = token;
            }
        });
    </script>
</body>
</html>
